<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Mapa en Tiempo Real de la Estación Espacial Internacional (ISS) | Seguimiento Satelital</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description"
        content="Visualiza la ubicación en tiempo real de la ISS con nuestro mapa interactivo. Seguimiento preciso y actualizado de la trayectoria de la Estación Espacial Internacional.">
    <meta name="keywords"
        content="ISS, mapa en tiempo real, estación espacial internacional, seguimiento satelital, órbita terrestre, NASA">
    <meta id="my-data" data-name='{{astronautas|tojson|safe}}'>


    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link rel="stylesheet" href="{{url_for('static',filename='css/mapa.css')}}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.21.13/dist/css/uikit.min.css" />
    <link rel="stylesheet" href="{{url_for('static',filename='css/panel.css')}}">
    <link rel="stylesheet" href="{{url_for('static',filename='css/slider.css')}}" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.10.4/themes/flick/jquery-ui.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.13/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.13/dist/js/uikit-icons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-ui-Slider-Pips/1.11.4/jquery-ui-slider-pips.min.js"></script>



</head>

<body>
    <div class="notification-container">
        <div id="notification" class="notification" style="display: none;">Notificación centrada</div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- This is a button toggling the off-canvas  BOTON QUE EXPANDE DESPLEGABLE OPCIONES-->
    <button id="opciones" uk-toggle="target: #my-id" type="button" style="position: fixed;border-radius: 0.5em;
    top:3em;left: 3em; font-size: 1.5em;padding: 0.5em;cursor: pointer;opacity: 0;z-index: 1;">
        Ver opciones
    </button>


    <div id="panel-astronautas" class="panel-dragable" style="display:none;top: 50%;z-index:2500;
        left: 50%;padding: 0.5em;position: absolute;
        transform: translate(-50%, -50%);width:300px; max-width: 70%;">
        <div class="panel-header">
            <h3>Astronautas en la ISS</h3>

            <button class="cerrar-panel">&times;</button>
        </div>

        <ul id="lista-astro" class="lista-astronautas">
            {% for astronauta in astronautas %}
            <li>
                <a href="#" class="astronauta-link" data-nombre="{{ astronauta.name }}">{{ astronauta.name }}</a>
            </li>
            {% endfor %}
        </ul>
        <div id="detalles-astronauta" style="display:none;"></div>
    </div>

    <div id="panel-astronauta"
        style="display:none; width: 90%; margin: 0 auto;margin-bottom: 3em panel-astronauta solo;background-color:transparent; padding: 10px;  z-index: 6000; margin-top:3em">
        <div class="panel-header" style="cursor: move; padding: 5px; background-color: white">
            <span>Detalles del Astronauta</span>
            <button onclick="cerrarPanelAstronauta()" style="float: right;">&times;</button>
        </div>
        <div id="detalles-astronauta"></div>
    </div>







    <!-- This is the off-canvas  DESPLEGABLE DE OPCIONES-->
    <div id="my-id" uk-offcanvas " >


        <div  class=" uk-offcanvas-bar" style="width: 600px !important;">

        <ul style="z-index: 1;float: left; margin-bottom: 1em;">
            <li id="latitud" style="z-index: 1;font-size: 1em;"></li>
            <li id="longitud" style="z-index: 1;font-size: 1em;"></li>
            <li id="contador" style="color: yellow;z-index: 1;">contador</li>
            <li id="contador-actualizaciones" style="z-index: 1;">contador</li>
            <li id="altura" style="z-index: 1;font-size: 1em;"></li>

            <li id="velocidad" style="z-index: 1;font-size: 1em;">
                Velocidad: <span id="velocidad-valor"></span> km/h
                <progress id="velocidad-barra" value="0" max="100"></progress>
                <span id="velocidad-rango"></span>
            </li>
        </ul>



        <div class="slider-container">
            <div id="sliderHandle">
                <div id="custom-handle" class="ui-slider-handle"></div>
            </div>
        </div>









        <ul uk-accordion="collapsible: true"
            style="background-color:rgb(60, 61, 61);width: 95%;position: relative; margin-top: 25vh;">

            <li>
                <a class="uk-accordion-title"
                    style="background-color:rgb(60, 61, 61);padding: 0.5em;border-bottom: 1px solid white;width: 95%;">Trayectorias</a>
                <div class="uk-accordion-content"
                    style="display: flex;flex-direction: column;align-items: center; width: 95%;">
                    <button onclick="ver_solo_estacion()" style="z-index: 1;border-radius: 0.5em;width: 80%;
                    font-size: 1.5em;padding: 0.5em;display: block;margin-bottom: 1em;cursor:pointer ;">
                        Trayectoria IIS en tiempo real</button>
                    <button onclick="lista_xml()" style="z-index: 1;border-radius: 0.5em;width: 80%;
                    font-size: 1.5em;padding: 0.5em;display: block;margin-bottom: 1em;cursor: pointer;">
                        Demo patrón Trayectoria publicada XML</button>
                    <button onclick="demo_estacion()" type="button" style="z-index: 1;border-radius: 0.5em;width: 80%;
                    font-size: 1.5em;padding: 0.5em;display: block;margin-bottom: 1em;cursor: pointer;">
                        Ver Animación Trayectoria publicada XML
                    </button>
                    <button id="borrar_xml" onclick="borrar_xml()"
                        style="background-color: blueviolet;color: white; z-index: 1;border-radius: 0.5em;width: 80%;
                    font-size: 1.5em;padding: 0.5em;display: block;margin-bottom: 1em;cursor: pointer;display: none;">Borrar/detener
                        animaciones</button>

                </div>
            </li>
            <li>
                <a class="uk-accordion-title"
                    style="background-color:rgb(60, 61, 61);padding: 0.5em;border-bottom: 1px solid white;width: 95%;">Buscador/localizador
                    (paises,ciudades,rios,etc...)</a>
                <input id="hideKeyboard" style="position: absolute; left: 0px; top: -20px; z-index: -1;" type="text"
                    name="hideKeyboard" readonly="readonly" />
                <div id="buscar_lugares" class="uk-accordion-content" style="width: 95%" ;>

                    <input id="caja-buscar" autofocus onkeypress="return event.keyCode != 13;" class="uk-input"
                        placeholder="busca (Pais,Ciudad,Rio,Lago...)" autocomplete="off" type="text"
                        style="width: 80%;margin-top: -1.2em;" name="buscador" hx-get="/obtener_coordenadas_ciudad"
                        hx-target="#ciudad" hx-trigger="keyup changed delay:1000ms" hx-swap="innerHTML "
                        hx-on::after-request="this.blur()">

                    <span id="limpiar" onclick="limpiar_caja()" style=" font-size: 2.6em; 
                         border: solid 1px rgb(151, 149, 149);background-color: darkgray;cursor: pointer;">X</span>
                    <!-- siguiente div es zona de inyección hTMX -->
                    <div id="ciudad" style="width: 85%; margin: 0 auto;"></div>
                </div>
            </li>
            <li>
                <a class="uk-accordion-title"
                    style="background-color:rgb(60, 61, 61);padding: 0.5em;border-bottom: 1px solid white;width: 95%;">Tags
                    favoritos</a>
                <div class="uk-accordion-content" style="width: 95%;">
                    <div id="Dublin" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Dublín</div>
                    <div id="Mallorca" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Mallorca</div>
                    <div id="Caracas" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Caracas</div>
                    <div id="Huelva" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Huelva</div>
                    <div id="Madrid" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Madrid</div>
                    <div id="Trinidad" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Trinidad y Tobago
                    </div>
                    <div id="Londres" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Londres</div>
                    <div id="Piramides_Giza" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Pirámides de Giza
                    </div>
                    <div id="Machu_Picchu" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Machu Picchu</div>
                    <div id="Taj_Mahal" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Taj Mahal</div>
                    <div id="Gran_Muralla" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Gran Muralla China
                    </div>
                    <div id="Petra" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Petra</div>
                    <div id="Estatua_Libertad" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Estatua de la
                        Libertad</div>
                    <div id="Torre_Eiffel" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Torre Eiffel</div>
                    <div id="Toledo" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Toledo</div>
                    <div id="Castillo de Orgaz" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Castillo de Orgaz
                    </div>

                    <div id="Catedral de Ciudad Real" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Toledo</div>
                    <div id="Acropolis_Atenas" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Acrópolis de Atenas
                    </div>
                    <div id="Coliseo_Roma" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Coliseo de Roma
                    </div>
                    <div id="Alhambra" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Alhambra</div>
                    <div id="Angkor_Wat" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Angkor Wat</div>
                    <div id="Sagrada_Familia" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Sagrada Familia
                    </div>
                    <div id="Gobekli_Tepe" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Göbekli Tepe</div>
                    <div id="Stonehenge" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Stonehenge</div>
                    <div id="Kaaba" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Kaaba</div>
                    <div id="Basilica_San_Pedro" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Basílica de San
                        Pedro</div>
                    <div id="Teotihuacan" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Teotihuacán</div>
                    <div id="Lalibela" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Lalibela</div>
                    <div id="Cataratas_Victoria" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Cataratas Victoria
                    </div>
                    <div id="Bosque_Bwindi" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Bosque Bwindi</div>
                    <div id="Isla_Pascua" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Isla de Pascua
                    </div>
                    <div id="Salar_Uyuni" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Salar de Uyuni
                    </div>
                    <div id="Cristo_Redentor" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Cristo Redentor
                    </div>
                    <div id="Yellowstone" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Yellowstone</div>
                    <div id="Cataratas_Niagara" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Cataratas del
                        Niágara</div>
                    <div id="Gran_Canon" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Gran Cañón</div>
                    <div id="Yellowknife" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Yellowknife</div>
                    <div id="Ciudad_Ur" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Ciudad de Ur</div>
                    <div id="Monte_Fuji" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Monte Fuji</div>
                    <div id="Ciudad_Prohibida" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Ciudad Prohibida
                    </div>
                    <div id="Bagan" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Bagan</div>
                    <div id="Cuevas_Ajanta" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Cuevas de Ajanta
                    </div>
                    <div id="Cuevas_Ellora" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Cuevas de Ellora
                    </div>
                    <div id="Venecia" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Venecia</div>
                    <div id="Santorini" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Santorini</div>
                    <div id="Castillo_Neuschwanstein" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Castillo de
                        Neuschwanstein</div>
                    <div id="Notre_Dame" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Notre-Dame</div>
                    <div id="Pompeya" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Pompeya</div>
                    <div id="Acueducto_Segovia" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Acueducto de
                        Segovia</div>
                    <div id="Puerto_Sydney" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Puerto de Sydney
                    </div>
                    <div id="Pinguinos_Phillip" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Pingüinos de
                        Phillip Island</div>
                    <div id="Gran_Barrera_Coral" class="uk-badge ciudades" onclick="moverMapa(this.id)"
                        style="color:white !important;font-size: 1.2em;height:1.2em; padding:0.8em;">Gran Barrera de
                        Coral</div>

            </li>
            <li>
                <a class="uk-accordion-title"
                    style="background-color:rgb(60, 61, 61);padding: 0.5em;width: 95%;border-bottom: 1px solid white">Consultar
                    días de visibilidad</a>
                <div class="uk-accordion-content" style="width: 95%;">
                    <form style="width: 100%;">


                        <select id="country" class="uk-select" name="country" required="" width="20" title="Country"
                            style="outline: none;" hx-get="/ciudades" hx-target="#select-ciudades" hx-trigger="change"
                            hx-swap="innerHTML ">
                            <option value="">Seleccionar País</option>
                            <option value="Argentina">Argentina</option>
                            <option value="Australia">Australia</option>
                            <option value="Brazil">Brasil</option>
                            <option value="Canada">Canadá</option>
                            <option value="Chile">Chile</option>
                            <option value="China">China</option>
                            <option value="Colombia">Colombia</option>
                            <option value="Ecuador">Ecuador</option>
                            <option value="Egypt">Egipto</option>
                            <option value="France">Francia</option>
                            <option value="Germany">Alemania</option>
                            <option value="India">India</option>
                            <option value="Indonesia">Indonesia</option>
                            <option value="Italy">Italia</option>
                            <option value="Japan">Japón</option>
                            <option value="Kenya">Kenia</option>
                            <option value="Mexico">México</option>
                            <option value="Morocco">Marruecos</option>
                            <option value="New_Zealand">Nueva Zelanda</option>
                            <option value="Nigeria">Nigeria</option>
                            <option value="Peru">Perú</option>
                            <option value="Russia">Rusia</option>
                            <option value="Saudi_Arabia">Arabia Saudita</option>
                            <option value="South_Africa">Sudáfrica</option>
                            <option value="South_Korea">Corea del Sur</option>
                            <option value="Spain">España</option>
                            <option value="United_Arab_Emirates">Emiratos rabes Unidos</option>
                            <option value="United_Kingdom">Reino Unido</option>
                            <option value="United_States">Estados Unidos</option>
                        </select>
                        </select>
                        <div id="select-ciudades"></div>
                        <div id="pasos" style="width: 100% !important;"></div>

                    </form>
                </div>
            </li>

            <li>
                <a class="uk-accordion-title"
                    style="background-color:rgb(60, 61, 61);padding: 0.5em;width: 95%;border-bottom: 1px solid white">Consultar
                    Videos interesantes</a>
                <div class="uk-accordion-content" style="width: 95%;">
                    <div style="margin: 0 auto" class="uk-grid-small uk-child-width-expand@s uk-text-center" uk-grid>
                        <!-- This is a button toggling the modal -->
                        <button id="https://www.youtube.com/embed/0JU4z-iLmGQ?si=e-WWioS1NEroiWOO"
                            onclick="pasar_src(this.id)" class="uk-button uk-button-default uk-margin-small-right"
                            type="button" style="min-width: 200px;" uk-toggle="target: #modal-example">
                            Recorrido por la ISS</button>
                        <button id="https://www.youtube.com/embed/7c7hgejxiCY?si=aO1maUyQqSfBsClw"
                            onclick="pasar_src(this.id)" class="uk-button uk-button-default uk-margin-small-right"
                            type="button" style="min-width: 200px;" uk-toggle="target: #modal-example">
                            Orbita completa a la Tierra</button>
                        <button id="https://www.youtube.com/embed/V0DXWZix5V0?si=cKm7YlgtYnAhzVN3"
                            onclick="pasar_src(this.id)" class="uk-button uk-button-default uk-margin-small-right"
                            type="button" style="min-width: 200px;" uk-toggle="target: #modal-example">
                            Así se vive en la ISS</button>
                        <button id="https://www.youtube.com/embed/lBfzX2FEIPg" onclick="pasar_src(this.id)"
                            class="uk-button uk-button-default uk-margin-small-right" type="button"
                            style="min-width: 200px;" uk-toggle="target: #modal-example">
                            Auroras boreales desde la ISS</button>
                        <button id="https://www.youtube.com/embed/4Po1gnl02Ls" onclick="pasar_src(this.id)"
                            class="uk-button uk-button-default uk-margin-small-right" type="button"
                            style="min-width: 200px;" uk-toggle="target: #modal-example">
                            vuelo nocturno de la ISS</button>
                        <button id="https://www.youtube.com/embed/3nlKH3fZmnk" onclick="pasar_src(this.id)"
                            class="uk-button uk-button-default uk-margin-small-right" type="button"
                            style="min-width: 200px;" uk-toggle="target: #modal-example">
                            ISS Timelapse - Bedtime in North America (16 September 2022)</button>
                        <button id="https://www.youtube.com/embed/3nlKH3fZmnk" onclick="pasar_src(this.id)"
                            class="uk-button uk-button-default uk-margin-small-right" type="button"
                            style="min-width: 200px;" uk-toggle="target: #modal-example">
                            ISS Timelapse - Bedtime in North America (16 September 2022)</button>

                    </div>

                    <!-- This is the modal of video-->
                    <div id="modal-example" uk-modal>
                        <div class="uk-modal-dialog uk-modal-body">
                            <h2 id="titulo-video" class=""></h2>
                            <div class="video-responsive">
                                <iframe id="myvideo" src="" title="YouTube video player" frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                            </div>
                            <button onclick="quitar_source()" class="uk-button uk-button-secondary uk-modal-close"
                                type="button" style="margin-top:1em">Close</button>

                            </p>
                        </div>
                    </div>

                    <!-- This is the modal of informacion-->
                    <div id="modal-info" class="uk-modal-container" uk-modal">
                        <div class="uk-modal-dialog uk-modal-body">
                            <button onclick="quitar_source()" class="uk-button uk-button-secondary uk-modal-close"
                                type="button" style="margin-top:1em">Close this window</button>
                            <h2 id="titulo-iframe" class=""></h2>
                            <div class="video-responsive">
                                <iframe id="myinfo" src="" title="YouTube video player" frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                            </div>
                            <button onclick="quitar_source_video()" class="uk-button uk-button-secondary uk-modal-close"
                                type="button" style="margin-top:1em">Close</button>

                            </p>
                        </div>
                    </div>








                </div>
            </li>


        </ul>
        <button id="cerrar-aside" class="uk-offcanvas-close" type="button" uk-close></button>

    </div>

    </div>




    <div id="map-overlay"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 1000;">
    </div>
    <div id="map" style="width: 100%; height: 100vh;"></div>
    <div id="mensaje-parpadeante"
        style="display: none; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 5px; font-size: 16px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 1000;">

        Zoom & click on the station to meet the astronauts.

    </div>




    <script defer src="{{url_for('static',filename='js/ciudades.js')}}" defer></script>
    <script defer src="https://unpkg.com/htmx.org@2.0.3"></script>
    <script>



        var puntos = []
        var map, marker;
        var nuevaLatitud, nuevaLongitud;
        var zoomy = 0.8;
        let issMarker;
        let seguimientoActivado = true; // Mueve esta línea aquí
        var map;
        const MAX_POINTS = 100; // Ajusta este número según tus necesidades
        let issCoordinates = []
        let lastLongitude = null;
        var ubicacionInicial;
        let lastUpdateTime = 0;
        let posicionInicial;
        let marcadores = [];
        let marcadores_favoritos = []
        let tamaño_marcador = 1; // Tamaño inicial del marcador
        let lastZoom = 0; // Almacena el último zoom
        const UPDATE_INTERVAL = 3000; // 3 segundos
        const demoMapStyle = 'mapbox://styles/mapbox/light-v10'; // O cualquier otro estilo que prefieras

        function crearMarcadorISS(lngLat) {
            console.log('Creando marcador ISS en:', lngLat);
            if (issMarker) {
                issMarker.remove(); // Eliminar el marcador existente si lo hay
            }
            var el = document.createElement('div');
            el.className = 'marker-iss';
            el.style.backgroundImage = 'url(/static/images/iss.png)';
            el.style.width = '40px';
            el.style.height = '40px';
            el.style.backgroundSize = 'contain';
            el.style.zIndex = 2000
            el.style.cursor = 'pointer';



            issMarker = new mapboxgl.Marker(el)
                .setLngLat(lngLat)
                .addTo(map);

            // Añadir evento de clic al marcador
            el.onclick = function (e) {

                e.stopPropagation();
                new mapboxgl.Popup()
                    .setLngLat(issMarker.getLngLat())
                    .setHTML('<div style="z-index:4000;text-align:center"><h5 style="margin:0 auto;margin-top:2em;">Estación Espacial Internacional</h5>' +
                        ' <button class="uk-button uk-button-primary" uk-toggle="target: #modal-integrantes" style="margin:1em" onclick="astronautas(this.closest(\'.mapboxgl-popup\'))">Ver integrantes</button></div>')
                    .addTo(map);
            };


            console.log('Marcador ISS creado:', issMarker);

            return issMarker;
        }



        function inicializarMapa() {
            console.log('Inicializando mapa...');
            ubicacionInicial = JSON.parse('{{ ubicacion | tojson | safe }}');
            posicionInicial = ubicacionInicial;
            console.log('Ubicación inicial:', ubicacionInicial);

            mapboxgl.accessToken = 'pk.eyJ1IjoiZ2EtZWR1YXJkbyIsImEiOiJjbDVmNzQyY3kwaHJpM2pvM29lOWVuZnVlIn0.a20bgkRxwewC43RomqCQ9g';

            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/satellite-streets-v12',
                center: ubicacionInicial,
                zoom: zoomy,
                maxZoom: 22,
                projection: 'globe'
            });

            console.log('Instancia del mapa creada');

            map.on('load', function () {
                console.log('Mapa cargado completamente');

                map.on('dragstart', function () {
                    seguimientoActivado = false;

                });

                // Inicializar el array de puntos con la ubicación inicial
                puntos = [ubicacionInicial];
                issCoordinates = [ubicacionInicial];

                // Añadir fuente y capa para la trayectoria de la ISS
                map.addSource('trayectoria-iss', {
                    'type': 'geojson',
                    'data': {
                        'type': 'Feature',
                        'properties': {},
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': puntos
                        }
                    }
                });

                map.addLayer({
                    'id': 'linea-iss',
                    'type': 'line',
                    'source': 'trayectoria-iss',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': '#3FB1CE',
                        'line-width': 2
                    }
                });



                // Añadir capa para el punto inicial
                map.addSource('punto-inicial', {
                    'type': 'geojson',
                    'data': {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Point',
                            'coordinates': ubicacionInicial
                        }
                    }
                });

                map.addLayer({
                    'id': 'punto-inicial',
                    'type': 'circle',
                    'source': 'punto-inicial',
                    'paint': {
                        'circle-radius': 6,
                        'circle-color': '#3FB1CE'
                    }
                });

                // Crear el marcador inicial de la ISS
                crearMarcadorISS(ubicacionInicial);

                // Añadir evento de zoom
                map.on('zoom', function () {
                    zoomy = map.getZoom();
                    actualizarSlider(zoomy);
                    actualizar_tamaño_favoritos(zoomy);
                });



                // Activar la transición
                fadeInMap();
                // Iniciar la actualización de la ubicación
                actualizarUbicacion();

                // Inicializar la ruta de la ISS
                initializeISSRoute();

                // Usar un intervalo más largo para dispositivos móviles
                const interval = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 10000 : 5000;
                setInterval(actualizarUbicacion, interval);

                // Optimizar el manejo de eventos
                let throttleTimer;
                const throttle = (callback, time) => {
                    if (throttleTimer) return;
                    throttleTimer = true;
                    setTimeout(() => {
                        callback();
                        throttleTimer = false;
                    }, time);
                };

                if (map) {
                    map.on('move', () => throttle(() => {
                        // Actualizar UI o realizar otras operaciones costosas aquí
                    }, 100));
                }
            });

            map.on('error', function (e) {
                console.error('Error en el mapa:', e);
            });









            // Verificar si el mapa está cargado correctamente
            if (map.loaded()) {
                console.log('Mapa cargado correctamente');
            } else {
                console.log('El mapa aún no está cargado');
                map.on('load', function () {
                    console.log('Mapa cargado');

                });
            }



            // Definir la función irAlSitio en el ámbito global
            let zoomAnterior;

            window.irAlSitio = function (lon, lat, zoom, popupToClose) {
                if (popupToClose) {
                    popupToClose.remove();
                }

                zoomAnterior = map.getZoom(); // Guardamos el zoom actual antes de cambiar

                setTimeout(() => {
                    map.flyTo({
                        center: [lon, lat],
                        zoom: zoom,
                        duration: 3000,
                        essential: true,
                        curve: 1.5,
                        easing: function (t) {
                            return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;
                        },
                    });
                }, 50);
            };

            window.volverAnterior = function (popupToClose) {
                if (popupToClose) {
                    popupToClose.remove();
                }



                setTimeout(() => {
                    map.flyTo({
                        center: map.getCenter(), // Mantenemos el centro actual
                        zoom: zoomAnterior,
                        duration: 3000,
                        essential: true,
                        curve: 1.5,
                        easing: function (t) {
                            return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;
                        },
                    });
                }, 50);
                actualizar_tamaño_favoritos(zoomAnterior)
            };

            // Inicializar el mapa
            map.on('load', function () {
                zoomAnterior = map.getZoom(); // Guardamos el zoom inicial
                console.log('Zoom inicial guardado:', zoomAnterior);
                console.log('Mapa cargado, llamando a añadirMarcadoresFavoritos');
                añadirMarcadoresFavoritos();
            });

            añadirMarcadoresFavoritos()


            let clickMarker; // Variable global para almacenar el marcador del clic

            // Definir el rango base para zoom 7
            const margenGradosBase = 0.25;
            const zoomBase = 7;

            function calcularMargenGrados(zoomActual) {
                // Calculamos la proporción basada en la diferencia de zoom
                // Un zoom menor resultará en un margen mayor
                const proporcion = Math.pow(2, zoomBase - zoomActual);
                return margenGradosBase * proporcion;
            }

            function onMapClick(e) {
                console.log('Evento de clic recibido:', e);

                const lng = e.lngLat.lng;
                const lat = e.lngLat.lat;
                const zoomActual = map.getZoom();

                console.log('Coordenadas del clic:', lat, lng);
                console.log('Zoom actual:', zoomActual);

                const margenGrados = calcularMargenGrados(zoomActual);
                console.log('Margen de grados calculado:', margenGrados);

                // Comprobar si ciudades existe y es un objeto
                if (typeof ciudades !== 'object' || ciudades === null) {
                    console.error('Error: ciudades no está definido o no es un objeto');
                    return;
                }

                // Comprobar si el clic está cerca de alguna ciudad
                const cercaDeCiudad = Object.values(ciudades).some(ciudad => {
                    if (!ciudad || !Array.isArray(ciudad.center) || ciudad.center.length < 2) {
                        console.warn('Ciudad inválida encontrada:', ciudad);
                        if (zoomy < 4) {
                            mostrarNotificacion('Se recomienda un Zoom más alto para trabajar con marcadores');
                        }
                        return false;
                    }

                    const ciudadLng = ciudad.center[0];
                    const ciudadLat = ciudad.center[1];

                    // Ajustar el margen de longitud basado en la latitud
                    const margenLngAjustado = margenGrados / Math.cos(ciudadLat * Math.PI / 180);

                    const dentroDeMargenLat = Math.abs(lat - ciudadLat) < margenGrados;
                    const dentroDeMargenLng = Math.abs(lng - ciudadLng) < margenLngAjustado;

                    return dentroDeMargenLat && dentroDeMargenLng;
                });

                if (!cercaDeCiudad) {
                    // Eliminar el marcador anterior si existe
                    if (zoomy < 4) {
                        mostrarNotificacion('Se recomienda un Zoom más alto para trabajar con marcadores');

                    }
                    if (clickMarker) {
                        clickMarker.remove();
                    }

                    // Crear el contenido del popup con estilos mejorados y el botón Salir centrado
                    const popupContent = `
                    <div style="z-index:9999">
            <h3>Ver pasos en esta ubicación</h3>
            <div style="margin-top:-1.5em">
                <button onclick="predecirPasosISS(${lat}, ${lng})" class="uk-button uk-button-primary" style="margin-bottom:0.5em; width:100%;">Mostrar pasos</button>
                <button onclick="street_view(${lat}, ${lng})" class="uk-button uk-button-primary" style="margin-bottom:0.5em; width:100%;">Ver en Street view</button>
                <button onclick="google_earth(${lat}, ${lng})" class="uk-button uk-button-primary" style="margin-bottom:0.5em; width:100%;">Ver en Google Earth</button>

                <div style="text-align:center;">
                    <button onclick="window.cerrarPopupYEliminarMarcador()" class="uk-button uk-button-secondary">Salir</button>
                </div>
            </div>
            </div>
        `;

                    // Crear el marcador con el popup
                    clickMarker = new mapboxgl.Marker()
                        .setLngLat([lng, lat])
                        .setPopup(new mapboxgl.Popup({ offset: 25, closeButton: false })
                            .setHTML(popupContent))
                        .addTo(map);

                    // Abrir el popup automáticamente
                    clickMarker.togglePopup();
                } else {
                    console.log('Clic cerca de una ciudad, no se realiza acción');
                    if (zoomy < 4) {
                        mostrarNotificacion('Se recomienda un Zoom más alto para trabajar con marcadores');
                    }
                }
            }

            // Hacer la función accesible globalmente
            window.cerrarPopupYEliminarMarcador = function () {
                if (clickMarker) {
                    // Cerrar el popup
                    const popup = clickMarker.getPopup();
                    if (popup.isOpen()) {
                        popup.remove();
                    }

                    // Eliminar el marcador
                    clickMarker.remove();
                    clickMarker = null;
                }
            };

            // Asegúrate de que el mapa esté cargado antes de añadir el evento de clic
            map.on('load', function () {
                console.log('Mapa cargado, añadiendo evento de clic');
                map.on('click', onMapClick);
            });





            function marcador_simple() {
                var marker = new mapboxgl.Marker()
                    .setLngLat([-3.70379, 40.41678]) // Coordenadas del marcador
                    .addTo(map)
                    .setPopup(new mapboxgl.Popup().setHTML('<h3>Coordenadas</h3><p>Latitud: ' + 40.41678 + '<br>Longitud: ' + (-3.70379) + '</p>'));

                marker.getPopup().on('open', function () {
                    var lngLat = marker.getLngLat();
                    marker.getPopup().setHTML('<h3>Coordenadas</h3><p>Latitud: ' + lngLat.lat + '<br>Longitud: ' + lngLat.lng + '</p>');
                });

                marker.getElement().addEventListener('click', function () {
                    marker.togglePopup();
                });

                console.log('Map and marker added successfully');
            }
        }

        function añadirMarcadoresFavoritos() {
            console.log('Iniciando añadirMarcadoresFavoritos');
            for (let lugar in ciudades) {
                let datos = ciudades[lugar];
                console.log(`Creando marcador para ${lugar}:`, datos);

                let el = document.createElement('div');
                el.className = 'marcador-favorito';
                el.style.backgroundImage = 'url(/static/images/icono_azul.png)';
                el.style.backgroundSize = 'contain';
                el.style.width = tamaño_marcador + 'px';
                el.style.height = tamaño_marcador + 'px';
                el.style.backgroundRepeat = 'no-repeat';
                el.style.backgroundPosition = 'center';
                el.style.cursor = 'pointer';
                el.style.zIndex = '1';
                el.style.display = "none"; // Inicialmente oculto

                let popup = new mapboxgl.Popup({ className: "popup" });

                let popupContent = `
            <div style="display:flex; flex-direction: column;"> 
                <h3>${lugar}</h3>
                <div style="margin-top:-1.5em;fornt-size:0.7em">
                    <button class="uk-button uk-button-primary" style="margin-bottom:0.5em" onclick="irAlSitio(${datos.center[0]}, ${datos.center[1]}, ${datos.zoom}, this.closest('.mapboxgl-popup'))">Ir al sitio</button>
                    <button class="uk-button uk-button-primary" style="margin-bottom:0.5em" onclick="informacion('${datos.informacion}', '${lugar}', this.closest('.mapboxgl-popup'))">Más información</button>
                    <button class="uk-button uk-button-primary" style="margin-bottom:0.5em" onclick="predecirPasosISS(${datos.center[1]}, ${datos.center[0]}, this.closest('.mapboxgl-popup'))">Predecir pasos ISS</button>
                    <button onclick="street_view(${datos.center[0]}, ${datos.center[1]})" class="uk-button uk-button-primary" style="margin-bottom:0.5em; width:100%;">Ver en Street view</button>
                <button onclick="google_earth(${datos.center[0]}, ${datos.center[1]})" class="uk-button uk-button-primary" style="margin-bottom:0.5em; width:100%;">Ver en Google Earth</button>
                     <button class="uk-button uk-button-secondary" onclick="volverAnterior(this.closest('.mapboxgl-popup'))">Exit</button>
                </div>
            </div>`;

                popup.setHTML(popupContent);

                var marker_fav = new mapboxgl.Marker(el)
                    .setLngLat(datos.center)
                    .setPopup(popup)
                    .addTo(map);

                console.log(`Marcador añadido para ${lugar}`);
                marcadores_favoritos.push(marker_fav);
            }

            setTimeout(function () {
                console.log('Finalizado añadirMarcadoresFavoritos');
                // Cambiar el estilo del elemento DOM del marcador
                marcadores_favoritos.forEach(marker => {
                    marker.getElement().style.display = "block"; // Mostrar el marcador
                });
            }, 200);
        }

        window.informacion = function (url, lugar, popupToClose) {
            if (popupToClose) {
                popupToClose.remove();
            }
            if (url.includes("youtube") || url.includes("cloudinary")) {
                document.getElementById('myvideo').setAttribute('src', url);
                document.getElementById('titulo-video').innerText = lugar
                UIkit.modal('#modal-example').show();
            }
            else {
                document.getElementById('myinfo').setAttribute('src', url);
                document.getElementById('titulo-iframe').innerText = lugar
                UIkit.modal('#modal-info').show();
            }

        }


        // Función para actaulizar todos los marcadores segun zoom cambia tamaño
        function actualizar_tamaño_favoritos(zoomy) {
            // Solo actualiza si el zoom ha cambiado significativamente
            if (Math.abs(zoomy - lastZoom) > 0.5) {
                marcadores_favoritos.forEach(marker => {
                    // Accede al elemento del marcador y actualiza su tamaño
                    const markerElement = marker.getElement();
                    switch (true) {
                        case (zoomy <= 1.4):
                            tamaño_marcador = 3;
                            break;
                        case (zoomy <= 1.9):
                            tamaño_marcador = 4;
                            break;
                        case (zoomy <= 3):
                            tamaño_marcador = 5;
                            break;
                        case (zoomy <= 4):
                            tamaño_marcador = 8;
                            break;
                        case (zoomy > 4 && zoomy <= 6):
                            tamaño_marcador = zoomy * 3;
                            break;
                        case (zoomy > 6):
                            tamaño_marcador = 20;
                            break;
                        case (zoomy > 8):
                            tamaño_marcador = 25;
                            break;
                        default:
                            tamaño_marcador = 3; // Valor por defecto si no se cumple ninguna condición
                    }


                    markerElement.style.width = tamaño_marcador + 'px';
                    markerElement.style.height = tamaño_marcador + 'px';
                });
                lastZoom = zoomy; // Actualiza el último zoom
            }
        }


        // Asegúrate de que esta función se llame cuando el mapa esté cargado
        function initializeISSRoute() {
            map.addSource('iss-route', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'geometry': {
                        'type': 'LineString',
                        'coordinates': []
                    }
                }
            });

            map.addLayer({
                'id': 'iss-route',
                'type': 'line',
                'source': 'iss-route',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#00ff00',
                    'line-width': 2,
                    'line-opacity': 0.8
                }
            });
        }






        function actualizarUbicacion() {
            const now = Date.now();
            if (now - lastUpdateTime < UPDATE_INTERVAL) return;
            lastUpdateTime = now;

            fetch('/actualizar_ubicacion')
                .then(response => response.json())
                .then(data => {

                    let newCoord = [data.longitud, data.latitud];

                    if (issMarker) {
                        issMarker.setLngLat(newCoord);
                    } else {
                        crearMarcadorISS(newCoord);
                    }

                    actualizarTrayectoriaISS(data.longitud, data.latitud);
                    actualizarInfoPosicion(data);
                })
                .catch(error => console.error('Error:', error));
        }






        const VELOCIDAD_MINIMA = 27530; // 0% del progress bar
        const VELOCIDAD_MAXIMA = 27616; // 100% del progress bar

        let ultimaVelocidad = 27650; // Inicializamos con un valor medio aproximado

        let contadorActualizaciones = 0;

        function actualizarInfoPosicion(data) {
            document.getElementById('latitud').textContent = `Latitud: ${data.latitud.toFixed(4)}`;
            document.getElementById('longitud').textContent = `Longitud: ${data.longitud.toFixed(4)}`;

            // Actualizar el contador
            contadorActualizaciones++;
            document.getElementById('contador-actualizaciones').textContent = `Actualizaciones: ${contadorActualizaciones}`;

            // Actualizar el valor de velocidad
            const velocidad = parseFloat(data.velocidad);
            const velocidadValor = document.getElementById('velocidad-valor');
            const velocidadBarra = document.getElementById('velocidad-barra');

            velocidadValor.textContent = velocidad.toFixed(2);

            // Calcular el valor para el progress bar
            const valorProgress = Math.max(0, Math.min(100,
                ((velocidad - VELOCIDAD_MINIMA) / (VELOCIDAD_MAXIMA - VELOCIDAD_MINIMA)) * 100
            ));
            velocidadBarra.value = valorProgress;

            // Cambiar el color del progress bar basado en el valor
            let color;
            if (valorProgress < 33) {
                color = '#00ff00'; // Verde
            } else if (valorProgress < 66) {
                color = '#ffff00'; // Amarillo
            } else {
                color = '#ff0000'; // Rojo
            }
            velocidadBarra.style.setProperty('--progress-color', color);

            // Actualizar el texto con el rango de velocidades
            document.getElementById('velocidad-rango').textContent =
                `Rango: ${VELOCIDAD_MINIMA.toFixed(0)} - ${VELOCIDAD_MAXIMA.toFixed(0)} km/h`;

            // Manejar el dato de altitud
            if (data.altitud != undefined) {
                document.getElementById('altura').textContent = `Altura: ${data.altitud.toFixed(2)} km`;
            } else {
                document.getElementById('altura').textContent = 'Altura: No disponible';
            }


        }

        function centrarMapa() {
            if (screen.width < 1200) {
                document.getElementById('cerrar-aside').click();
            }
            if (issMarker) {
                map.easeTo({
                    center: issMarker.getLngLat(),
                    zoom: zoomy,
                    duration: 1000,
                    easing: function (t) {
                        return t * (2 - t);
                    }
                });
            }
        }

        // Usar requestAnimationFrame para animaciones suaves
        function animarMarcador(timestamp) {
            // Lógica de animación aquí
            requestAnimationFrame(animarMarcador);
        }
        requestAnimationFrame(animarMarcador);

        function adjustCoordinates(coords) {
            let adjustedCoords = [];
            let segments = [];
            let segment = [];

            for (let i = 0; i < coords.length; i++) {
                let coord = coords[i];
                if (i > 0) {
                    let prevCoord = segment[segment.length - 1];
                    let diff = coord[0] - prevCoord[0];
                    if (Math.abs(diff) > 180) {
                        // Cruce de línea de fecha detectado
                        segments.push(segment);
                        segment = [];
                    }
                }
                segment.push(coord);
            }
            if (segment.length > 0) {
                segments.push(segment);
            }

            // Devolver el último segmento completo
            return segments[segments.length - 1] || [];
        }

        // Inicia la actualización periódica
        setInterval(actualizarUbicacion, 1000); // Actualiza cada segundo

        function lista_xml() {
            document.getElementById('borrar_xml').style.display = "block"
            var ubicaciones = JSON.parse('{{ lista | tojson | safe }}');



            // Eliminar capas y fuentes existentes si las hay
            ['iss-points'].forEach(function (layer) {
                if (map.getLayer(layer)) map.removeLayer(layer);
                if (map.getSource(layer)) map.removeSource(layer);
            });

            // Crear array de coordenadas para los puntos
            var coordinates = ubicaciones.map(function (ubicacion) {
                return [parseFloat(ubicacion[0]), parseFloat(ubicacion[1])];
            }).filter(coord => !isNaN(coord[0]) && !isNaN(coord[1]));

            // Añadir la fuente y la capa de los puntos
            map.addSource('iss-points', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': coordinates.map(function (coord) {
                        return {
                            'type': 'Feature',
                            'geometry': {
                                'type': 'Point',
                                'coordinates': coord
                            }
                        };
                    })
                }

            });

            map.addLayer({
                'id': 'iss-points',
                'type': 'circle',
                'source': 'iss-points',
                'paint': {
                    'circle-radius': 3,
                    'circle-color': '#3FB1CE',
                    'circle-opacity': 0.8
                }

            });

            // Ajustar la vista del mapa
            var bounds = coordinates.reduce(function (bounds, coord) {
                return bounds.extend(coord);
            }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));

            map.fitBounds(bounds, {
                padding: 50,
                zoom: 1.5,
                duration: 2000
            });

            if (screen.width < 1200) {
                document.getElementById('cerrar-aside').click();
            }
        }

        let intentosRestantes = 3; // Número de intentos permitidos
        let botonBloqueado = false; // Estado del botón

        function borrar_xml() {
            if (botonBloqueado) {
                console.log('Procesando solicitud. Por favor, espere...');
                return;
            }

            botonBloqueado = true;
            document.getElementById('borrar_xml').disabled = true; // Deshabilita visualmente el botón

            function intentarBorrar() {
                try {
                    if (!map || !map.loaded()) {
                        throw new Error('El mapa no está cargado o definido');
                    }

                    // Código para borrar XML y detener animaciones
                    // ... (tu lógica actual para borrar XML y detener animaciones) ...

                    console.log('XML borrado y animaciones detenidas con éxito');
                    intentosRestantes = 3; // Reinicia el contador de intentos
                    botonBloqueado = false;
                    document.getElementById('borrar_xml').disabled = false; // Habilita el botón
                } catch (error) {
                    console.error('Error al borrar XML o detener animaciones:', error.message);
                    intentosRestantes--;

                    if (intentosRestantes > 0) {
                        console.log(`Reintentando en 300ms. Intentos restantes: ${intentosRestantes}`);
                        setTimeout(intentarBorrar, 300);
                    } else {
                        console.error('No se pudo completar la operación después de varios intentos');
                        intentosRestantes = 3; // Reinicia el contador de intentos
                        botonBloqueado = false;
                        document.getElementById('borrar_xml').disabled = false; // Habilita el botón
                    }
                }
            }

            intentarBorrar();
        }

        function go_zoom() {
            if (map) {
                map.easeTo({
                    zoom: zoomy,
                    duration: 500,
                });
                actualizarSlider(zoomy);
            }
        }

        $(function () {
            var handle = $("#custom-handle");
            $("#sliderHandle").slider({
                range: 'min',
                min: 0,
                max: 23,
                value: zoomy,
                step: 0.1,
                create: function () {
                    handle.text(zoomy.toFixed(1));
                },
                slide: function (event, ui) {
                    zoomy = ui.value;
                    handle.text(zoomy.toFixed(1));
                    if (map) {
                        map.easeTo({
                            zoom: zoomy,
                            duration: 500,
                        });
                    }
                }
            });
            actualizarSlider(zoomy);
        });

        function fadeInMap() {
            console.log('Iniciando fade in del mapa');
            document.getElementById('map').style.opacity = '1';
            document.getElementById('map-overlay').style.opacity = '0';

            setTimeout(function () {
                console.log('Removiendo overlay');
                document.getElementById('map-overlay').style.display = 'none';
                mostrarMensajeParpadeante();
            }, 2000);
        }

        function mostrarMensajeParpadeante() {
            const mensaje = document.getElementById('mensaje-parpadeante');
            mensaje.style.display = 'block';
            mensaje.style.opacity = '0';

            // Animación de entrada
            let opacidad = 0;
            const fadeIn = setInterval(() => {
                if (opacidad < 1) {
                    opacidad += 0.1;
                    mensaje.style.opacity = opacidad;
                } else {
                    clearInterval(fadeIn);
                    setTimeout(() => {
                        ocultarMensaje();
                    }, 5000);

                }
            }, 50);



            function ocultarMensaje() {
                const fadeOut = setInterval(() => {
                    if (opacidad > 0) {
                        opacidad -= 0.1;
                        mensaje.style.opacity = opacidad;
                    } else {
                        clearInterval(fadeOut);
                        mensaje.style.display = 'none';
                    }
                }, 50);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM cargado, inicializando mapa...');
            inicializarMapa();

        });




        function actualizarSlider(zoom) {
            $("#sliderHandle").slider("value", zoom);
            $("#custom-handle").text(zoom.toFixed(1));
            zoomy = zoom; // Actualiza la variable global zoomy
        }
        let lista = JSON.parse('{{ lista | tojson | safe }}');

        function demo() {
            console.log("Iniciando demo");
            // Ocultar la capa de tiempo real
            if (map.getLayer('linea-iss')) {
                map.setLayoutProperty('linea-iss', 'visibility', 'none');
            }
            if (issMarker) {
                issMarker.remove();
            }



            if (!map.loaded()) {
                console.log("Mapa no cargado, esperando evento 'load'");
                map.on('load', demo);
                return;
            }

            console.log("Mapa cargado, continuando con demo");

            // Borrar todas las capas relacionadas con demo
            map.getStyle().layers.forEach(function (layer) {
                if (layer.id.startsWith('iss-demo-')) {
                    map.removeLayer(layer.id);
                }
            });



            var coordinates = '{{ lista | tojson | safe }}';
            console.log("Número de coordenadas:", coordinates.length);

            coordinates = JSON.parse(coordinates);

            // Filtrar coordenadas válidas
            coordinates = coordinates.filter(coord => Array.isArray(coord) && coord.length >= 2 && !isNaN(coord[0]) && !isNaN(coord[1]));

            if (coordinates.length === 0) {
                console.error("No hay coordenadas válidas para mostrar");
                return;
            }

            // Interpolación geodésica de puntos
            var interpolatedCoordinates = []
            var interpolationSteps = 10

            for (var i = 0; i < coordinates.length - 1; i++) {
                var start = coordinates[i]
                var end = coordinates[i + 1]
                interpolatedCoordinates.push(start)

                var line = turf.lineString([start, end])
                var length = turf.length(line)
                var step = length / interpolationSteps

                for (var j = 1; j < interpolationSteps; j++) {
                    var interpolated = turf.along(line, step * j)
                    interpolatedCoordinates.push(interpolated.geometry.coordinates)
                }
            }
            interpolatedCoordinates.push(coordinates[coordinates.length - 1])

            coordinates = interpolatedCoordinates
            console.log("Número de coordenadas interpoladas:", coordinates.length);

            // Añadir source y layer para los puntos
            map.addSource('iss-demo-points', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': coordinates.map(coord => ({
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Point',
                            'coordinates': coord
                        }
                    }))
                }
            });

            map.addLayer({
                'id': 'iss-demo-points',
                'type': 'circle',
                'source': 'iss-demo-points',
                'paint': {
                    'circle-radius': 2,  // tamaño del punto
                    'circle-color': '#3FB1CE',
                    'circle-opacity': 0.8
                }
            });

            // Ajustar la vista del mapa suavemente
            var bounds = coordinates.reduce(function (bounds, coord) {
                return bounds.extend(coord);
            }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));

            map.fitBounds(bounds, {
                padding: 50,
                duration: 1000, // duración de la animación en milisegundos
                maxZoom: 3 // limitar el zoom máximo
            });

            if (screen.width < 1200) {
                document.getElementById('cerrar-aside').click();
            }
        }

        // Declarar issMarker globalmente al principio de tu archivo JavaScript

        let animationSpeed = 810; // Duplicamos el valor original de 405
        let isAnimating = false; // Variable para controlar si la animación está en curso

        function demo_estacion() {
            console.log("Iniciando demo_estacion");
            if (screen.width < 1200) {
                document.getElementById('cerrar-aside').click();
            }

            if (!map || !map.loaded()) {
                console.error("El mapa no está cargado o definido");
                return;
            }

            console.log("Mapa cargado, continuando con demo_estacion");

            // Borrar todas las capas relacionadas con demo_estacion
            map.getStyle().layers.forEach(function (layer) {
                if (layer.id.startsWith('iss-demo-')) {
                    map.removeLayer(layer.id);
                }
            });

            // Borrar todas las fuentes relacionadas con demo_estacion
            var sources = map.getStyle().sources;
            for (var sourceId in sources) {
                if (sourceId.startsWith('iss-demo-')) {
                    map.removeSource(sourceId);
                }
            }

            // Remover todos los marcadores existentes
            if (window.issMarkers) {
                window.issMarkers.forEach(marker => marker.remove());
            }
            window.issMarkers = [];

            // Limpiar cualquier animación previa
            if (window.issAnimationFrame) {
                cancelAnimationFrame(window.issAnimationFrame);
            }

            var coordinates = '{{ lista | tojson | safe }}';
            console.log("Número de ubicaciones en lista:", coordinates.length);

            coordinates = JSON.parse(coordinates);

            coordinates = coordinates.filter(ubicacion => Array.isArray(ubicacion) && ubicacion.length >= 2)
                .map(function (ubicacion) {
                    return [parseFloat(ubicacion[0]), parseFloat(ubicacion[1])];
                }).filter(coord => !isNaN(coord[0]) && !isNaN(coord[1]));

            console.log("Número de coordenadas válidas:", coordinates.length);

            if (coordinates.length === 0) {
                console.error("No hay coordenadas válidas para mostrar");
                return;
            }

            console.log("Primera coordenada:", coordinates[0]);
            console.log("Última coordenada:", coordinates[coordinates.length - 1]);

            // Interpolacin geodésica de puntos
            var interpolatedCoordinates = []
            var interpolationSteps = 10

            for (var i = 0; i < coordinates.length - 1; i++) {
                var start = coordinates[i]
                var end = coordinates[i + 1]
                interpolatedCoordinates.push(start)

                var line = turf.lineString([start, end])
                var length = turf.length(line)
                var step = length / interpolationSteps

                for (var j = 1; j < interpolationSteps; j++) {
                    var interpolated = turf.along(line, step * j)
                    interpolatedCoordinates.push(interpolated.geometry.coordinates)
                }
            }
            interpolatedCoordinates.push(coordinates[coordinates.length - 1])

            coordinates = interpolatedCoordinates
            console.log("Número de coordenadas interpoladas:", coordinates.length);

            // Ajustar la vista inicial del mapa
            map.jumpTo({
                center: [0, 0],
                zoom: 1.5,
                pitch: 0,
                bearing: 0
            });

            console.log("Vista del mapa ajustada");

            // Crear un elemento HTML para el marcador de la ISS
            var el = document.createElement('div');
            el.className = 'iss-marker';
            el.style.backgroundImage = 'url(/static/images/iss.png)';
            el.style.width = '40px';
            el.style.height = '40px';
            el.style.backgroundSize = 'contain';

            // Crear el marcador
            var marker = new mapboxgl.Marker(el)
                .setLngLat(coordinates[0])
                .addTo(map);

            window.issMarkers = [marker];

            console.log("Marcador de la ISS añadido al mapa");

            // Añadir fuente y capa para los puntos de la trayectoria
            map.addSource('iss-demo-points', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });

            map.addLayer({
                'id': 'iss-demo-points',
                'type': 'circle',
                'source': 'iss-demo-points',
                'paint': {
                    'circle-radius': 3,
                    'circle-color': '#3FB1CE',
                    'circle-opacity': 0.8
                }
            });

            var currentIndex = 0;
            var lastTimestamp = 0;
            var animationSpeed = 50; // ms entre cada frame
            var rotationSpeed = 0.1; // grados por frame

            function animateEarthAndISS(timestamp) {
                if (timestamp - lastTimestamp >= animationSpeed) {
                    // Rotar la Tierra
                    var currentCenter = map.getCenter();
                    map.setCenter([currentCenter.lng - rotationSpeed, currentCenter.lat]);

                    if (currentIndex < coordinates.length) {
                        var currentCoord = coordinates[currentIndex];
                        console.log("Moviendo ISS a:", currentCoord);

                        // Mover el marcador a la nueva posición
                        marker.setLngLat(currentCoord);

                        var source = map.getSource('iss-demo-points');
                        var features = source._data.features;
                        features.push({
                            'type': 'Feature',
                            'geometry': {
                                'type': 'Point',
                                'coordinates': currentCoord
                            }
                        });
                        source.setData({
                            'type': 'FeatureCollection',
                            'features': features
                        });

                        currentIndex++;
                    } else {
                        // Si hemos llegado al final de la lista, reiniciamos
                        currentIndex = 0;
                    }

                    lastTimestamp = timestamp;
                }

                window.issAnimationFrame = requestAnimationFrame(animateEarthAndISS);
            }

            console.log("Iniciando animación");
            window.issAnimationFrame = requestAnimationFrame(animateEarthAndISS);
        }


        function actualizarTrayectoriaISS(lng, lat) {
            let nuevoPunto = [lng, lat];

            if (puntos.length === 0) {
                puntos.push(posicionInicial);
            }

            if (puntos.length > 0) {
                let ultimoPunto = puntos[puntos.length - 1];

                // Detectar si cruzamos el meridiano 180°
                if (Math.abs(nuevoPunto[0] - ultimoPunto[0]) > 180) {
                    // Ajustar la longitud del nuevo punto para una transición suave
                    if (nuevoPunto[0] > ultimoPunto[0]) {
                        nuevoPunto[0] -= 360;
                    } else {
                        nuevoPunto[0] += 360;
                    }
                }
            }

            puntos.push(nuevoPunto);

            // Mantener un máximo de puntos para la trayectoria
            if (puntos.length > 100) {
                puntos = puntos.slice(-100);
            }

            // Normalizar las longitudes para evitar saltos en la visualización
            let puntosNormalizados = puntos.map(p => {
                return [((p[0] + 540) % 360) - 180, p[1]];
            });

            // Actualizar la fuente de datos
            var source = map.getSource('trayectoria-iss');
            if (source) {
                source.setData({
                    'type': 'Feature',
                    'properties': {},
                    'geometry': {
                        'type': 'LineString',
                        'coordinates': puntosNormalizados
                    }
                });
            } else {
                console.error('Fuente de datos trayectoria-iss no encontrada');
            }

            // Dibujar una línea desde la posición inicial hasta la posición actual
            var sourceDirecta = map.getSource('linea-directa-iss');
            if (sourceDirecta) {
                sourceDirecta.setData({
                    'type': 'Feature',
                    'properties': {},
                    'geometry': {
                        'type': 'LineString',
                        'coordinates': [posicionInicial, nuevoPunto]
                    }
                });
            } else {
                map.addSource('linea-directa-iss', {
                    'type': 'geojson',
                    'data': {
                        'type': 'Feature',
                        'properties': {},
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': [posicionInicial, nuevoPunto]
                        }
                    }
                });
                map.addLayer({
                    'id': 'linea-directa-iss',
                    'type': 'line',
                    'source': 'linea-directa-iss',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': '#3FB1CE',
                        'line-width': 2
                    }
                });
            }
        }

        function street_view(latitud, longitud) {
            const ubicacion = `${latitud},${longitud}`;
            const url_google_maps = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${ubicacion}&t=${new Date().getTime()}`; // Agregado parámetro único

            // Abrir la URL de Google Maps en una nueva pestaña
            window.open(url_google_maps, '_blank');
        }

        function google_earth(latitud, longitud) {
            const ubicacion = `${latitud},${longitud}`;
            const url_google_earth = `https://earth.google.com/web/@${ubicacion},1?t=${new Date().getTime()}&rand=${Math.random()}`; // Agregado parámetro único

            window.open(url_google_earth, '_blank');
        }
















    </script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <script src="{{url_for('static',filename='js/contador.js')}}"></script>
    <script src="{{url_for('static',filename='js/script.js')}}"></script>
    <script src="https://unpkg.com/draggabilly@2/dist/draggabilly.pkgd.min.js"></script>

    <script type="application/ld+json">

    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Mapa en Tiempo Real de la ISS",
      "description": "Seguimiento en vivo de la Estación Espacial Internacional",
      "url": "https://iss-edu.vercel.app/",
      "applicationCategory": "Mapa",
      "operatingSystem": "Web"
    }
    </script>
</body>

</html>